var Dom=YAHOO.util.Dom;var Event=YAHOO.util.Event;var DDM=YAHOO.util.DragDropMgr;var inputPans=['input_area_xchart','input_area_imrchart','input_area_pchart','input_area_npchart','input_area_uchart','input_area_cchart'];var currentItemId=1;var chart=null;var parameters;function showError(a){Dom.get("error_content").innerHTML=a;Dom.setStyle("errorPan","display","block")};var saveOrder=function(){var d=function(a){var b=a.getElementsByTagName("li");var c="";for(i=0;i<b.length;i++){c+=b[i].getElementsByTagName("b")[0].innerHTML+"|"}return c};Dom.setStyle("save_bt","display","none");Dom.setStyle("loading","display","block");var e=Dom.get("List");var f="order="+d(e);var g=function(o){Dom.setStyle("save_bt","display","block");Dom.setStyle("loading","display","none")};var h={success:g};var j=YAHOO.util.Connect.asyncRequest('POST','saveCookie.php',h,f)};(function(){YAHOO.example.DDApp={init:function(){new YAHOO.util.DDTarget("List");for(j=1;j<total;j=j+1){new YAHOO.example.DDList("item"+j)}}};YAHOO.example.DDList=function(a,b,c){YAHOO.example.DDList.superclass.constructor.call(this,a,b,c);this.logger=this.logger||YAHOO;var d=this.getDragEl();Dom.setStyle(d,"opacity",0.67);d.className="dragEl";this.goingUp=false;this.lastY=0};YAHOO.extend(YAHOO.example.DDList,YAHOO.util.DDProxy,{ignoreX:true,ignoreY:false,startDrag:function(x,y){this.logger.log(this.id+" startDrag");var a=this.getDragEl();var b=this.getEl();Dom.setStyle(b,"visibility","hidden");a.innerHTML=b.innerHTML},endDrag:function(e){var a=this.getEl();var b=this.getDragEl();Dom.setStyle(b,"visibility","");var c=b.id;Dom.setStyle(c,"visibility","hidden");Dom.setStyle(a,"visibility","")},onDrag:function(e){var y=Event.getPageY(e);if(y<this.lastY){this.goingUp=true}else if(y>this.lastY){this.goingUp=false}this.lastY=y},onDragOver:function(e,a){var b=this.getEl();var c=Dom.get(a);if(c.nodeName.toLowerCase()=="li"){var d=b.parentNode;var p=c.parentNode;if(this.goingUp){p.insertBefore(b,c)}else{p.insertBefore(b,c.nextSibling)}DDM.refreshCache()}}});Event.onDOMReady(YAHOO.example.DDApp.init,YAHOO.example.DDApp,true)})();function setCurrent(a){Dom.get("item"+currentItemId).className="notEditDiv";Dom.get("item"+a).className="editingDiv";Dom.setStyle("errorPan","display","none");Dom.setStyle("completePan","display","none");Dom.setStyle("completePan2","display","none");Dom.get("recordBt").disabled=false;setTitle();currentItemId=a;setInputPan(a)};function setTitle(){Dom.setStyle("current_chart_title","color","red");setTimeout(function(){Dom.setStyle("current_chart_title","color","black")},1000)};function setInputPan(a){hideAllPans();var b=Dom.get("item"+a).getElementsByTagName("b")[0].innerHTML;if(chart==null)chart=new Chart("../charts.xml");parameters=chart.getParameters(b);if(parameters==null)return;Dom.get("current_chart_title").innerHTML="<img src='../img/little_chart.gif'> <span class='type'>"+chartTypes[parameters['type']]+"</span> "+parameters['name'];if(parameters['description']+parameters['fileName']){Dom.get("chart_description").innerHTML="<a tabindex='-100' target=_blank href='../chart/description.php?id="+parameters['id']+"'>描述</a>"}else{Dom.get("chart_description").innerHTML=""}switch(parseInt(parameters['type'])){case TYPE_XR:case TYPE_XS:var p="<span>控制限</span><b>"+parameters['lcl_x']+" ~ "+parameters['ucl_x'];p+="</b>&nbsp;&nbsp;<span>规格限</span><b>"+parameters['lsl']+" ~ "+parameters['usl']+"</b>";Dom.get("chart_parameters").innerHTML=p;Dom.setStyle(inputPans[0],"display","block");Dom.get('sample_size_x').innerHTML="(子组大小:"+parameters['sample_size']+")";Dom.get("sampleValue_x").focus();Dom.get("sampleValue_x").value="";Dom.get("sampleID_x").value="";break;case TYPE_IMR:var p="<span>控制限</span><b>"+parameters['lcl_x']+" ~ "+parameters['ucl_x'];p+="</b>&nbsp;&nbsp;<span>规格限</span><b>"+parameters['lsl']+" ~ "+parameters['usl']+"</b>";Dom.get("chart_parameters").innerHTML=p;Dom.setStyle(inputPans[1],"display","block");Dom.get("sampleValue_imr").focus();Dom.get("sampleValue_imr").value="";Dom.get("sampleID_imr").value="";break;case TYPE_P:var p="<span>中心线CL</span><b>"+parameters['cl'];Dom.get("chart_parameters").innerHTML=p;Dom.setStyle(inputPans[2],"display","block");Dom.get("sampleValue_p").focus();Dom.get("sampleValue_p").value="";Dom.get("sampleSize_p").value="";Dom.get("sampleID_p").value="";break;case TYPE_NP:var p="<span>中心线CL</span><b>"+parameters['cl'];Dom.get("chart_parameters").innerHTML=p;Dom.get("sampleSize_np").value=parameters['sample_size'];Dom.setStyle(inputPans[3],"display","block");Dom.get("sampleValue_np").focus();Dom.get("sampleValue_np").value="";Dom.get("sampleID_np").value="";break;case TYPE_U:var p="<span>中心线CL</span><b>"+parameters['cl'];Dom.get("chart_parameters").innerHTML=p;Dom.setStyle(inputPans[4],"display","block");Dom.get("sampleValue_u").focus();Dom.get("sampleValue_u").value="";Dom.get("sampleSize_u").value="";Dom.get("sampleID_u").value="";break;case TYPE_C:var p="<span>中心线CL</span><b>"+parameters['cl'];Dom.get("chart_parameters").innerHTML=p;Dom.setStyle(inputPans[5],"display","block");Dom.get("sampleValue_c").focus();Dom.get("sampleValue_c").value="";Dom.get("sampleID_c").value="";break}};function hideAllPans(){for(var i=0;i<inputPans.length;i++){Dom.setStyle(inputPans[i],"display","none")}};function submitData(){Dom.setStyle("errorPan","display","none");Dom.setStyle("completePan","display","none");Dom.setStyle("completePan2","display","none");Dom.get("recordBt").disabled=true;var c=parseInt(parameters['type']);var d="";var e="id="+parameters['id'];switch(c){case TYPE_XR:case TYPE_XS:var f=splitData(Dom.get("sampleValue_x").value);var g=splitData(Dom.get("sampleID_x").value);if(f.length!=parameters['sample_size']){d+="样本数量不正确，样本数应为："+parameters['sample_size']+"，输入时请注意换行或空格<br>"}for(var i=0;i<f.length;i++){if(!isNumber(f[i])){d+="样本值必须为数值类型<br>";break}e+="&v"+i+"="+f[i]}if(YAHOO.lang.trim(Dom.get("sampleID_x").value)!=""&&g.length!=parameters['sample_size']){d+="标识数量不正确，样本数应为："+parameters['sample_size']+"，输入时请注意换行或空格<br>"}else{for(var i=0;i<g.length;i++){e+="&p"+i+"="+g[i]}}break;case TYPE_IMR:var h=YAHOO.lang.trim(Dom.get("sampleValue_imr").value);var g=YAHOO.lang.trim(Dom.get("sampleID_imr").value);if(!isNumber(h)){d+="样本值必须为数值类型<br>"}e+="&v0="+h+"&p0="+g;break;case TYPE_P:var h=YAHOO.lang.trim(Dom.get("sampleValue_p").value);var j=YAHOO.lang.trim(Dom.get("sampleSize_p").value);var g=YAHOO.lang.trim(Dom.get("sampleID_p").value);if(!isZeroInt(h)){d+="不良数必须为整数类型<br>"}if(!isInt(j)){d+="子组大小必须为正整数类型<br>"}if(parseInt(h)>parseInt(j)){d+="不良数应该 <= 子组大小<br>"}e+="&v="+h+"&s="+j+"&p="+g;break;case TYPE_NP:var h=YAHOO.lang.trim(Dom.get("sampleValue_np").value);var j=YAHOO.lang.trim(Dom.get("sampleSize_np").value);var g=YAHOO.lang.trim(Dom.get("sampleID_np").value);if(!isZeroInt(h)){d+="不良数必须为整数类型<br>"}if(parseInt(h)>parseInt(j)){d+="不良数应该 <= 子组大小<br>"}e+="&v="+h+"&s="+j+"&p="+g;break;case TYPE_U:var h=YAHOO.lang.trim(Dom.get("sampleValue_u").value);var j=YAHOO.lang.trim(Dom.get("sampleSize_u").value);var g=YAHOO.lang.trim(Dom.get("sampleID_u").value);if(!isZeroInt(h)){d+="缺陷数必须为整数类型<br>"}if(!isInt(j)&&j!=1){d+="子组大小必须为正整数类型<br>"}e+="&v="+h+"&s="+j+"&p="+g;break;case TYPE_C:var h=YAHOO.lang.trim(Dom.get("sampleValue_c").value);var g=YAHOO.lang.trim(Dom.get("sampleID_c").value);if(!isZeroInt(h)){d+="缺陷数必须为整数类型<br>"}e+="&v="+h+"&p="+g;break}if(d!=""){showError(d);Dom.get("recordBt").disabled=false}else{var k=function(o){var r=o.responseText;if(r==1){if(manual==2){var a=Dom.get("item"+currentItemId).nextSibling;if(a.id=="item0"){Dom.setStyle("completePan","display","block")}else{var b=a.id.replace("item","");setCurrent(b)}}else{Dom.setStyle("completePan2","display","block")}}else{showError(r)}Dom.get("recordBt").disabled=false};var l={success:k};var m=YAHOO.util.Connect.asyncRequest('POST','saveRecord.php',l,e)}};function splitData(a){a=YAHOO.lang.trim(a);var b=a.replace(/\s+/g,"|");var v=b.split("|");return v};var focusFlag=1;function endWithBlank(a){e=/\s+$/;return(e.test(a))};function hotkey(){if(parseInt(parameters['type'])<TYPE_P){if(focusFlag==0){Dom.get("tab_temp").focus();endWithBlank(Dom.get("sampleValue_x").value);if(YAHOO.lang.trim(Dom.get("sampleValue_x")).value==''){Dom.get("sampleValue_x").value=""}else if(!endWithBlank(Dom.get("sampleValue_x").value)){Dom.get("sampleValue_x").value=Dom.get("sampleValue_x").value+"\n"}focusFlag=1;return}else{Dom.get("sampleValue_x").focus();if(YAHOO.lang.trim(Dom.get("sampleID_x").value)==''){Dom.get("sampleID_x").value=""}else if(!endWithBlank(Dom.get("sampleID_x").value)){Dom.get("sampleID_x").value=Dom.get("sampleID_x").value+"\n"}focusFlag=0;return}}};var tab=new YAHOO.util.KeyListener(document,{keys:[9]},{fn:hotkey});tab.enable();var submit=new YAHOO.util.KeyListener(document,{ctrl:true,keys:[13]},{fn:submitData});submit.enable();var shiftManual=function(){if(manual==1){Dom.get('shifter').innerHTML='自动';manual=2}else{Dom.get('shifter').innerHTML='手动';manual=1}var a=function(o){};var b={success:a};var c=YAHOO.util.Connect.asyncRequest('POST','saveCookie.php',b,"manual="+manual)};Event.onDOMReady(function(){setCurrent(1);Event.addListener(Dom.get("sampleValue"),"focus",function(){focusFlag=1});Event.addListener(Dom.get("sampleID"),"focus",function(){focusFlag=0});Event.addListener(Dom.get("save_bt"),"click",saveOrder);Event.addListener(Dom.get("recordBt"),"click",submitData);Event.addListener(Dom.get("shifter"),"click",shiftManual)});